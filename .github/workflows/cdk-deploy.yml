name: CDK Deploy on AWS

on:
    push:
        branches:
            - main
      
jobs:
    build:
        runs-on: ubuntu-latest
        environment: Production
        permissions:
            contents: read
            id-token: write
        env:
            APP_NAME: ${{ vars.APP_NAME }}
            ACCOUNT_AWS: ${{ vars.ACCOUNT_AWS }}
            REGION_AWS: ${{ vars.REGION_AWS }}
            
            VERIFICATION_SUBJECT: ${{ vars.VERIFICATION_SUBJECT }}
            VERIFICATION_BODY: ${{ vars.VERIFICATION_BODY }}
            COGNITO_DOMAIN_NAME: ${{ vars.COGNITO_DOMAIN_NAME }}
            COGNITO_CUSTOM_DOMAIN: ${{ vars.COGNITO_CUSTOM_DOMAIN }}
            ARN_COGNITO_CERTIFICATE: ${{ vars.ARN_COGNITO_CERTIFICATE }}
            CALLBACK_URLS: ${{ vars.CALLBACK_URLS }}
            LOGOUT_URLS: ${{ vars.LOGOUT_URLS }}
            
            API_AUTHORIZER_PUBLISH_ZIP: ${{ vars.API_AUTHORIZER_PUBLISH_ZIP }}
            
            PUBLISH_ZIP: ${{ vars.PUBLISH_ZIP }}
            HANDLER: ${{ vars.HANDLER }}
            TIMEOUT: ${{ vars.TIMEOUT }}
            MEMORY_SIZE: ${{ vars.MEMORY_SIZE }}
            DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
            API_MAPPING_KEY: ${{ vars.API_MAPPING_KEY }}
            VPC_ID: ${{ vars.VPC_ID }}
            PRIVATE_WITH_INTERNET_ID_1: ${{ vars.PRIVATE_WITH_INTERNET_ID_1 }}
            PRIVATE_WITH_INTERNET_ID_2: ${{ vars.PRIVATE_WITH_INTERNET_ID_2 }}
            RDS_SECURITY_GROUP_ID: ${{ vars.RDS_SECURITY_GROUP_ID }}
            
            ALLOWED_DOMAINS: ${{ vars.ALLOWED_DOMAINS }}
            SECRET_ARN_CONNECTION_STRING: ${{ vars.SECRET_ARN_CONNECTION_STRING }}
            
            APP_SCHEMA_NAME: ${{ vars.APP_SCHEMA_NAME }}
            INITIAL_CREATION_HANDLER: ${{ vars.INITIAL_CREATION_HANDLER }}
            INITIAL_CREATION_PUBLISH_ZIP: ${{ vars.INITIAL_CREATION_PUBLISH_ZIP }}
            MIGRATION_SCRIPT: ${{ vars.MIGRATION_SCRIPT }}
                        
        steps:
            - name: Checkout Repositorio
              uses: actions/checkout@v4
      
            - name: Instalar .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ vars.VERSION_DOTNET }}
      
            - name: Instalar Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ vars.VERSION_NODEJS }}
                                                      
            - name: Instalar AWS CDK
              run: npm install -g aws-cdk
              
            - name: Instalar .NET EF
              run: dotnet tool install --global dotnet-ef --version ${{ vars.VERSION_DOTNET_EF }}
              
            - name: .NET Restore
              run: dotnet restore
              
            - name: Publish .NET Initial Creation Lambda
              working-directory: ${{ vars.INITIAL_CREATION_DIRECTORY }}
              run: dotnet publish /p:PublishDir=../publish /p:PublishReadyToRun=true -r linux-arm64 --no-self-contained
              
            - name: Creaci√≥n de bundle EF Migrations
              run: dotnet ef migrations script --idempotent -o ${{ vars.INITIAL_CREATION_DIRECTORY }}/publish/${{ vars.MIGRATION_SCRIPT }} --project ${{ vars.PROJECT_NAME }} --startup-project ${{ vars.PROJECT_NAME_DESIGN }}
              
            - name: Compress Publish Directory .NET Initial Creation Lambda
              working-directory: ${{ vars.INITIAL_CREATION_DIRECTORY }}/publish
              run: zip -r -q -T ./publish.zip ./*
                        
            - name: Build and Compress Rust API Authorizer
              working-directory: ${{ vars.API_AUTHORIZER_DIRECTORY }}
              run: |
                cargo build --release --target x86_64-unknown-linux-gnu
                cp target/x86_64-unknown-linux-gnu/release/${{ vars.API_AUTHORIZER_PROJECT_NAME }} ./bootstrap
                zip ${{ vars.API_AUTHORIZER_PROJECT_NAME }}.zip bootstrap                   
                  
            - name: Publish .NET AoT Minimal API
              run: |
                  docker run --rm -v ${{ github.workspace }}:/src -w /src public.ecr.aws/amazonlinux/amazonlinux:2023 \bash -c "
                    yum install -y dotnet-sdk-8.0 gcc zlib-devel && 
                    dotnet publish ${{ vars.PROJECT_NAME }} /p:PublishDir=../publish /p:PublishAot=true -r linux-x64 --self-contained &&
                    cd ./publish &&
                    zip -r -T ./publish.zip ./*"
      
            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4
              with:
                  aws-region: ${{ vars.REGION_AWS }}
                  role-to-assume: ${{ vars.ARN_GITHUB_ROLE }}
                  
            - name: CDK Synth
              working-directory: ${{ vars.DIRECTORIO_CDK }}
              run: cdk synth
              
            - name: CDK Diff
              working-directory: ${{ vars.DIRECTORIO_CDK }}
              run: cdk --app cdk.out diff
              
            - name: CDK Deploy
              working-directory: ${{ vars.DIRECTORIO_CDK }}
              run: cdk --app cdk.out deploy --require-approval never --no-previous-parameters
          